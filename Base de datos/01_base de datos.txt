CREATE DATABASE EcoStoreDB;
GO

USE EcoStoreDB;

-- Tablas
CREATE TABLE Categorias(
    Id INT PRIMARY KEY IDENTITY,
    Nombre NVARCHAR(100) NOT NULL UNIQUE,
    Descripcion NVARCHAR(500),
    FechaCreacion DATETIME DEFAULT GETDATE()
);

CREATE TABLE Productos(
    Id INT PRIMARY KEY IDENTITY,
    Nombre NVARCHAR(100) NOT NULL,
    Descripcion NVARCHAR(500),
    Precio DECIMAL(18,2) NOT NULL CHECK (Precio > 0),
    Stock INT NOT NULL CHECK (Stock >= 0),
    CategoriaId INT FOREIGN KEY REFERENCES Categorias(Id),
    EsEcologico BIT NOT NULL DEFAULT 1,
    UrlImagen NVARCHAR(500) NULL,  -- Nueva columna agregada
    FechaCreacion DATETIME DEFAULT GETDATE()
);

CREATE TABLE Usuarios(
    Id UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID(),
    Correo NVARCHAR(100) NOT NULL UNIQUE,
    HashPassword VARBINARY(MAX) NOT NULL,  -- Modificado
    SalPassword VARBINARY(MAX) NOT NULL,  -- Modificado
    Nombre NVARCHAR(100) NOT NULL,  -- Modificado
    Rol NVARCHAR(20) DEFAULT 'Usuario',
    FechaCreacion DATETIME DEFAULT GETDATE()
);

CREATE TABLE Carrito(
    Id INT PRIMARY KEY IDENTITY,
    UsuarioId UNIQUEIDENTIFIER FOREIGN KEY REFERENCES Usuarios(Id),
    ProductoId INT FOREIGN KEY REFERENCES Productos(Id),
    Cantidad INT NOT NULL CHECK (Cantidad > 0),
    FechaAgregado DATETIME DEFAULT GETDATE()
);

CREATE TABLE Ordenes(
    Id UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID(),
    UsuarioId UNIQUEIDENTIFIER FOREIGN KEY REFERENCES Usuarios(Id),
    FechaOrden DATETIME DEFAULT GETDATE(),
    MontoTotal DECIMAL(18,2) NOT NULL,
    Estado NVARCHAR(20) DEFAULT 'Pendiente' CHECK (Estado IN ('Pendiente', 'Procesando', 'Enviado', 'Entregado', 'Cancelado')),
    DireccionEnvio NVARCHAR(500) NOT NULL
);

CREATE TABLE DetallesOrden(
    Id INT PRIMARY KEY IDENTITY,
    OrdenId UNIQUEIDENTIFIER FOREIGN KEY REFERENCES Ordenes(Id),
    ProductoId INT FOREIGN KEY REFERENCES Productos(Id),
    Cantidad INT NOT NULL CHECK (Cantidad > 0),
    PrecioUnitario DECIMAL(18,2) NOT NULL
);


INSERT INTO Usuarios (Nombre, Correo, Rol, HashPassword, SalPassword) 
VALUES (
    'Admin', 
    'admin2@ecostore.com', 
    'Administrador', 
    0x818347E5DCE00C7B83E7DCE7D2B625DD74800CA0F617FE244F24A6C00AD8144F3948A3D98465F6B2FE12D0115A95DFD4D9A5DA7C2B5C5D52197228DE237CFA54, 
    0x31E4A603226CDE9372004B1B27ECF8357DA53BD3DA60E40111E2E61EB0ED6EA4D2DACA857492A784510233A4E4AE43DB774DABBA90EBFFF8F5DA5A2D64FC755A
);
-- la pass del admin2 es 1234Admin
